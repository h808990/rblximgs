<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Roblox → GitHub Image Uploader</title>

<!-- FAVICON -->
<link rel="icon" type="image/png" href="https://i.imgur.com/UWB11xy.png">

<style>
body { background:#0d0d0d; color:#fff; font-family:Arial; padding:25px; }
h2 { margin-bottom:10px; }
.box { background:#1b1b1b; padding:20px; border-radius:10px; max-width:600px; margin:auto; }
input, button { width:100%; margin-top:10px; padding:10px; border-radius:6px; border:none; font-size:16px; }
button { background:#4CAF50; color:white; cursor:pointer; }
button:hover { opacity:0.8; }
#output { margin-top:20px; word-break:break-all; }
#copyBtn { background:#2196F3; margin-top:15px; display:none; }

/* Table */
.tableBox { margin:auto; margin-top:30px; max-width:650px; background:#1b1b1b; padding:20px; border-radius:10px; }
table { width:100%; border-collapse:collapse; }
td { padding:10px; border-bottom:1px solid #333; }
img { width:60px; height:60px; object-fit:cover; border-radius:6px; }

/* Copy buttons */
.copySmall {
    background:#2196F3;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    border:none;
    margin-left:10px;
}

.copySmall:hover {
    opacity:0.8;
}

/* Pagination */
.pageBtns { margin-top:10px; text-align:center; }
.pageBtns button { width:auto; padding:8px 16px; background:#333; }

/* Drop overlay */
#dropOverlay {
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.6);
    z-index:9999;
    color:#fff;
    font-size:20px;
}
#dropOverlay.show { display:flex; }
#dropOverlay p { background:rgba(0,0,0,0.5); padding:16px 24px; border-radius:8px; }
</style>
</head>
<body>

<div class="box">
<h2>Roblox → GitHub Image Uploader</h2>

<label>Your GitHub Token (saved automatically)</label>
<input type="password" id="token" placeholder="Paste token once">
<button id="copyTokenBtn" onclick="copyToken()" style="background:#555; margin-top:8px;">Copy Token</button>

<label>Upload Local Image</label>
<input type="file" id="fileInput" accept="image/*">

<label>OR paste a Roblox image URL</label>
<input type="text" id="robloxUrl" placeholder="https://tr.rbxcdn.com/...">

<button onclick="startUpload()">Upload</button>

<div id="output">Status: Waiting...</div>
<button id="copyBtn" onclick="copyLink()">Copy Link</button>
</div>

<!-- IMAGE HISTORY LIST -->
<div class="tableBox">
<h3>Uploaded Images</h3>
<div id="historyTable"></div>
<div class="pageBtns">
<button onclick="prevPage()">Previous</button>
<button onclick="nextPage()">Next</button>
</div>
</div>

<div id="dropOverlay"><p>Drop image to upload to GitHub</p></div>

<!-- CLIPBOARD PERMISSION MODAL -->
<div id="clipboardModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#111; color:#fff; padding:20px; border-radius:10px; max-width:420px; width:90%; text-align:center;">
    <h3 style="margin-top:0;">Allow Clipboard Access</h3>
    <p style="font-size:14px; color:#ddd; margin:10px 0;">To copy your token, the browser will request permission to write to the clipboard. Please click "Allow" if your browser asks.</p>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
      <button id="clipboardAllowBtn" style="padding:10px 14px; border-radius:6px; border:none; background:#2196F3; color:#fff;">Allow & Copy</button>
      <button id="clipboardCancelBtn" style="padding:10px 14px; border-radius:6px; border:none; background:#555; color:#fff;">Cancel</button>
    </div>
  </div>
</div>

<script>
// -------- SETTINGS --------
const owner = "h808990";
const repo  = "rblximgs";
let lastURL = "";
let page = 0;
const itemsPerPage = 10;

// -------- AUTO-LOAD TOKEN --------
window.onload = () => {
    const saved = localStorage.getItem("github_token");
    if (saved) document.getElementById("token").value = saved;
    // Load history for the current token (if any)
    loadHistory();
};

// -------- SAVE TOKEN --------
document.getElementById("token").addEventListener("input", function() {
    localStorage.setItem("github_token", this.value.trim());
    // Whenever token changes, reload history for that token
    loadHistory();
});

// -------- SHOW MESSAGE --------
function show(msg) {
    document.getElementById("output").innerHTML = msg;
}

 // -------- COPY HELPERS & BUTTONS --------
async function copyText(text, successMsg = "✅ Copied to clipboard") {
    if (!text) return show("❌ Nothing to copy");
    // Try navigator.clipboard first
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            return show(successMsg);
        }
    } catch (e) {
        // fall through to prompt fallback
    }
    // Fallback: open a prompt so user can manually copy (works without user activation)
    const ok = window.prompt("Copy the text below (Ctrl/Cmd+C):", text);
    if (ok === null) show("Copy cancelled");
    else show(successMsg);
}

// Copy last uploaded link
function copyLink() {
    if (!lastURL) return show("No link to copy");
    copyText(lastURL, "✅ Link copied to clipboard");
}

/* Copy stored GitHub token
   Improved flow: show a modal to ensure a user gesture triggers the clipboard write,
   which prompts the browser's clipboard permission UI when needed.
*/
function copyToken() {
    const token = document.getElementById("token").value.trim();
    if (!token) return show("❌ No token to copy");

    // Show modal
    const modal = document.getElementById('clipboardModal');
    const allowBtn = document.getElementById('clipboardAllowBtn');
    const cancelBtn = document.getElementById('clipboardCancelBtn');
    modal.style.display = 'flex';

    // Clean up handlers to avoid duplicate listeners
    const cleanup = () => {
        allowBtn.onclick = null;
        cancelBtn.onclick = null;
        modal.style.display = 'none';
    };

    allowBtn.onclick = async () => {
        cleanup();
        // Attempt to write to clipboard (this is the user gesture that triggers permission prompt)
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(token);
                show("✅ Token copied to clipboard");
            } else {
                // Fallback to existing copy helper which will prompt the user with a manual copy dialog
                copyText(token, "✅ Token copied to clipboard");
            }
        } catch (err) {
            // If permission denied or blocked, provide fallback and show message
            show("⚠️ Clipboard write blocked. Use the manual copy dialog.");
            copyText(token, "✅ Token copied to clipboard");
        }
    };

    cancelBtn.onclick = () => {
        cleanup();
        show("Copy cancelled");
    };
}

// -------- START UPLOAD --------
async function startUpload() {
    document.getElementById("copyBtn").style.display = "none";
    const token = document.getElementById("token").value.trim();
    const localFile = document.getElementById("fileInput").files[0];
    const robloxUrl = document.getElementById("robloxUrl").value.trim();

    if (!token) return show("❌ Error: Missing GitHub token");

    if (localFile) return uploadLocal(token, localFile);
    if (robloxUrl) return uploadRoblox(token, robloxUrl);

    show("❌ Error: Select a file or paste a Roblox link");
}

// -------- HANDLE ROBLOX URL --------
async function uploadRoblox(token, url){
    show("Downloading Roblox image...");

    try {
        const resp = await fetch(url);
        if (!resp.ok) return show("❌ Could not download Roblox image");

        const blob = await resp.blob();
        const file = new File([blob], "roblox.webp", { type: blob.type });

        uploadLocal(token, file);
    } catch (err) {
        show("❌ Roblox download error: " + err);
    }
}

// -------- MAIN UPLOAD FUNCTION --------
async function uploadLocal(token, file){
    const ext = (file.name || "png").split('.').pop();
    const fname = `img_${Date.now()}.${ext}`;

    show("Converting to Base64...");
    const base64 = await toBase64(file);

    show("Reading repo branch...");
    const repoData = await fetch(`https://api.github.com/repos/${owner}/${repo}`)
        .then(r=>r.json())
        .catch(()=>({ default_branch: 'main' }));
    const branch = repoData.default_branch || "main";

    show("Uploading to GitHub...");
    const uploadUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(fname)}`;

    try {
        const response = await fetch(uploadUrl, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Accept": "application/vnd.github+json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message:`Upload ${fname}`,
                content: base64
            })
        });

        const data = await response.json();

        if (!response.ok) {
            return show("❌ Upload failed:<br>" + JSON.stringify(data, null, 2));
        }

        lastURL = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${encodeURIComponent(fname)}`;

        // Attempt to auto-copy the uploaded link. If blocked, show permission modal so user can allow and retry.
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(lastURL);
                show("✅ Uploaded! (Link copied to clipboard)");
            } else {
                // No clipboard API available — fall back to manual copy dialog
                show("✅ Uploaded! (Click Copy button to copy link)");
            }
        } catch (err) {
            // Clipboard write blocked by browser; prompt the permission modal to let user allow/cancel and retry copying the link
            show("✅ Uploaded! (Click Allow to copy link)");
            // Ensure the modal is set to copy the link when allowed
            const clipboardModalEl = document.getElementById('clipboardModal');
            if (clipboardModalEl) {
                clipboardModalEl.dataset.copyType = 'link';
                clipboardModalEl.style.display = 'flex';
            }
        }

        document.getElementById("copyBtn").style.display = "block";
        document.getElementById("robloxUrl").value = "";

        addToHistory(lastURL);
    } catch (err) {
        show("❌ Upload error: " + err);
    }
}

// -------- Base64 --------
function toBase64(file){
    return new Promise((res, rej)=>{
        const reader = new FileReader();
        reader.onload = ()=>res(reader.result.split(',')[1]);
        reader.onerror = err=>rej(err);
        reader.readAsDataURL(file);
    });
}

// -------- HISTORY --------
function _historyKeyForToken(token) {
    return `upload_history_${token || 'anon'}`;
}

function getHistoryForToken(token) {
    const key = _historyKeyForToken(token);
    try {
        return JSON.parse(localStorage.getItem(key) || "[]");
    } catch(e) {
        return [];
    }
}

function setHistoryForToken(token, list) {
    const key = _historyKeyForToken(token);
    localStorage.setItem(key, JSON.stringify(list || []));
}

function addToHistory(url){
    const token = document.getElementById("token").value.trim() || 'anon';
    let list = getHistoryForToken(token);

    list.unshift({ url: url, time: Date.now() });

    // keep a reasonable max history length
    list = list.slice(0, 200);

    setHistoryForToken(token, list);
    loadHistory();
}

function loadHistory(){
    const token = document.getElementById("token").value.trim() || 'anon';
    let list = getHistoryForToken(token);

    const start = page * itemsPerPage;
    const end = start + itemsPerPage;
    const slice = list.slice(start, end);

    let html = "<table>";

    slice.forEach(item => {
        // escape single quotes for inline onclick
        const safeUrl = (item.url || "").replace(/'/g, "\\'");
        html += `
        <tr>
            <td><img src="${item.url}"></td>
            <td style="vertical-align:middle;">
                <button class="copySmall" onclick="copyText('${safeUrl}', '✅ Link copied to clipboard')">
                    Copy Link
                </button>
            </td>
        </tr>`;
    });

    html += "</table>";
    document.getElementById("historyTable").innerHTML = html;
}

function nextPage(){
    const token = document.getElementById("token").value.trim() || 'anon';
    let list = getHistoryForToken(token);
    if ((page + 1) * itemsPerPage < list.length){
        page++;
        loadHistory();
    }
}

function prevPage(){
    if (page > 0){
        page--;
        loadHistory();
    }
}

/* -------- DRAG & DROP SUPPORT (anywhere on page) --------
   - Drops a File image => uploads directly
   - Drops plain image URL => downloads then uploads
*/
const dropOverlay = document.getElementById('dropOverlay');

function showOverlay(show) {
    if (show) dropOverlay.classList.add('show');
    else dropOverlay.classList.remove('show');
}

window.addEventListener('dragover', (e) => {
    e.preventDefault();
    showOverlay(true);
});

window.addEventListener('dragleave', (e) => {
    // hide overlay when leaving window
    if (e.clientX === 0 && e.clientY === 0) showOverlay(false);
});

window.addEventListener('drop', async (e) => {
    e.preventDefault();
    showOverlay(false);

    const token = document.getElementById("token").value.trim();
    if (!token) {
        show("❌ Error: Missing GitHub token (paste it in the box first)");
        return;
    }

    // If files present, prefer first image file
    const dt = e.dataTransfer;
    if (dt && dt.files && dt.files.length) {
        const file = dt.files[0];
        if (file.type && file.type.startsWith('image/')) {
            show("Dropping file: uploading...");
            return uploadLocal(token, file);
        }
    }

    // Otherwise try to extract URL/text from dataTransfer
    const text = dt.getData('text/plain') || dt.getData('text/uri-list');
    if (text) {
        // If text looks like a URL, try to fetch as image
        try {
            const url = text.trim();
            if (/^https?:\/\//i.test(url)) {
                show("Dropping URL: downloading then uploading...");
                return uploadRoblox(token, url);
            } else {
                show("Dropped text is not a URL: " + text);
            }
        } catch (err) {
            show("❌ Drop handling error: " + err);
        }
    } else {
        show("❌ No usable image found in drop");
    }
});
</script>

</body>
</html>
