// -------- MAIN UPLOAD FUNCTION --------
async function uploadLocal(token, file){
    const ext = file.name.split('.').pop();
    const fname = `img_${Date.now()}.${ext}`;

    show("Converting to Base64...");
    const base64 = await toBase64(file);

    show("Reading repo branch...");
    const repoData = await fetch(`https://api.github.com/repos/${owner}/${repo}`)
        .then(r=>r.json());
    const branch = repoData.default_branch || "main";

    show("Uploading to GitHub...");
    const uploadUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(fname)}`;

    const response = await fetch(uploadUrl, {
        method: "PUT",
        headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message:`Upload ${fname}`,
            content: base64
        })
    });

    const data = await response.json();

    if (!response.ok) {
        return show("❌ Upload failed:<br>" + JSON.stringify(data, null, 2));
    }

    lastURL = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${encodeURIComponent(fname)}`;

    // ---------- AUTO-COPY USING CLIPBOARD PERMISSION ----------
    try {
        const permission = await navigator.permissions.query({ name: "clipboard-write" });

        if (permission.state === "granted" || permission.state === "prompt") {
            await navigator.clipboard.writeText(lastURL);
        }
        // If permission is "denied", silently skip
    } catch (err) {
        // Ignore clipboard permission errors completely
    }

    show(`Uploaded ✔ (auto-copied)`);

    // Button visible only if user wants to manually copy
    document.getElementById("copyBtn").style.display = "block";

    // Clear Roblox URL field AFTER upload
    document.getElementById("robloxUrl").value = "";

    addToHistory(lastURL);
}
