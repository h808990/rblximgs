<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Roblox → GitHub Image Uploader</title>
<style>
body { background:#0d0d0d; color:#fff; font-family:Arial; padding:25px; }
h2 { margin-bottom:10px; }
.box { background:#1b1b1b; padding:20px; border-radius:10px; max-width:600px; margin:auto; }
input, button { width:100%; margin-top:10px; padding:10px; border-radius:6px; border:none; font-size:16px; }
button { background:#4CAF50; color:white; cursor:pointer; }
button:hover { opacity:0.8; }
#output { margin-top:20px; word-break:break-all; }
#copyBtn { background:#2196F3; margin-top:15px; display:none; }

/* Table */
.tableBox { margin:auto; margin-top:30px; max-width:650px; background:#1b1b1b; padding:20px; border-radius:10px; }
table { width:100%; border-collapse:collapse; }
td { padding:10px; border-bottom:1px solid #333; vertical-align:middle; }
img { width:60px; height:60px; object-fit:cover; border-radius:6px; }

/* Pagination */
.pageControls {
    text-align:center;
    font-size:20px;
    margin-bottom:15px;
    user-select:none;
}
.pageArrow {
    cursor:pointer;
    padding:5px 15px;
    background:#333;
    border-radius:6px;
    margin:0 10px;
    display:inline-block;
}
.pageArrow:hover {
    background:#444;
}
</style>
</head>
<body>

<div class="box">
<h2>Roblox → GitHub Image Uploader</h2>

<label>Your GitHub Token (saved automatically)</label>
<input type="password" id="token" placeholder="Paste token once">

<label>Upload Local Image</label>
<input type="file" id="fileInput" accept="image/*">

<label>OR paste a Roblox image URL</label>
<input type="text" id="robloxUrl" placeholder="https://tr.rbxcdn.com/...">

<button onclick="startUpload()">Upload</button>

<div id="output">Status: Waiting...</div>
<button id="copyBtn" onclick="copyLink()">Copy Link</button>
</div>

<!-- IMAGE HISTORY LIST -->
<div class="tableBox">

<div id="pagination" class="pageControls"></div>

<div id="historyTable"></div>

</div>

<script>
// -------- SETTINGS --------
const owner = "h808990";
const repo  = "rblximgs";
let lastURL = "";
let page = 0;
const itemsPerPage = 10;

// -------- AUTO-LOAD TOKEN --------
window.onload = () => {
    const saved = localStorage.getItem("github_token");
    if (saved) document.getElementById("token").value = saved;
    loadHistory();
};

// -------- SAVE TOKEN WHEN TYPED --------
document.getElementById("token").addEventListener("input", function() {
    localStorage.setItem("github_token", this.value.trim());
});

// -------- SHOW MESSAGE --------
function show(msg) {
    document.getElementById("output").innerHTML = msg;
}

// -------- COPY BUTTON FOR MAIN UPLOAD --------
function copyLink() {
    navigator.clipboard.writeText(lastURL)
        .then(() => alert("Copied!"));
}

// -------- MAIN START FUNCTION --------
async function startUpload() {
    document.getElementById("copyBtn").style.display = "none";

    const token = document.getElementById("token").value.trim();
    const localFile = document.getElementById("fileInput").files[0];
    const robloxUrl = document.getElementById("robloxUrl").value.trim();

    if (!token) return show("❌ Error: Missing GitHub token");

    if (localFile) return uploadLocal(token, localFile);

    if (robloxUrl) {
        document.getElementById("robloxUrl").value = ""; // CLEAR AFTER CLICK
        return uploadRoblox(token, robloxUrl);
    }

    show("❌ Error: Select a file or paste a Roblox link");
}

// -------- HANDLE ROBLOX URL --------
async function uploadRoblox(token, url){
    show("Downloading Roblox image...");

    try {
        const resp = await fetch(url);
        if (!resp.ok) return show("❌ Could not download Roblox image");

        const blob = await resp.blob();
        const file = new File([blob], "roblox.webp", { type: blob.type });

        uploadLocal(token, file);
    } catch (err) {
        show("❌ Roblox download error: " + err);
    }
}

// -------- MAIN UPLOAD FUNCTION --------
async function uploadLocal(token, file){
    const ext = file.name.split('.').pop();
    const fname = `img_${Date.now()}.${ext}`;

    show("Converting to Base64...");
    const base64 = await toBase64(file);

    show("Reading repo branch...");
    const repoData = await fetch(`https://api.github.com/repos/${owner}/${repo}`)
        .then(r=>r.json());
    const branch = repoData.default_branch || "main";

    show("Uploading to GitHub...");
    const uploadUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(fname)}`;

    const response = await fetch(uploadUrl, {
        method: "PUT",
        headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message:`Upload ${fname}`,
            content: base64
        })
    });

    const data = await response.json();

    if (!response.ok) {
        return show("❌ Upload failed:<br>" + JSON.stringify(data, null, 2));
    }

    lastURL = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${encodeURIComponent(fname)}`;

    show(`✅ Uploaded!`);
    document.getElementById("copyBtn").style.display = "block";

    addToHistory(lastURL);
}

// -------- Base64 --------
function toBase64(file){
    return new Promise((res, rej)=>{
        const reader = new FileReader();
        reader.onload = ()=>res(reader.result.split(',')[1]);
        reader.onerror = err=>rej(err);
        reader.readAsDataURL(file);
    });
}

// -------- HISTORY SYSTEM --------
function addToHistory(url){
    let list = JSON.parse(localStorage.getItem("upload_history") || "[]");

    list.unshift({
        url: url,
        time: Date.now()
    });

    localStorage.setItem("upload_history", JSON.stringify(list));
    loadHistory();
}

function loadHistory(){
    let list = JSON.parse(localStorage.getItem("upload_history") || "[]");

    const totalPages = Math.ceil(list.length / itemsPerPage);
    const start = page * itemsPerPage;
    const end = start + itemsPerPage;

    const slice = list.slice(start, end);

    // --- Pagination UI ---
    document.getElementById("pagination").innerHTML = `
        <span class="pageArrow" onclick="prevPage()">◀</span>
        ${page + 1} / ${Math.max(totalPages, 1)}
        <span class="pageArrow" onclick="nextPage()">▶</span>
    `;

    // --- Table ---
    let html = "<table>";

    slice.forEach(item => {
        html += `
        <tr>
            <td><img src="${item.url}"></td>
            <td>
                <button style="background:#2196F3;width:auto;padding:8px 12px"
                    onclick="navigator.clipboard.writeText('${item.url}').then(()=>alert('Copied!'))">
                    Copy Link
                </button>
            </td>
        </tr>`;
    });

    html += "</table>";

    document.getElementById("historyTable").innerHTML = html;
}

function nextPage(){
    let list = JSON.parse(localStorage.getItem("upload_history") || "[]");
    const totalPages = Math.ceil(list.length / itemsPerPage);

    if (page + 1 < totalPages){
        page++;
        loadHistory();
    }
}

function prevPage(){
    if (page > 0){
        page--;
        loadHistory();
    }
}
</script>

</body>
</html>
